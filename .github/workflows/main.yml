name: üöÄ Deploy Promo Sales Service

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üîê Checkout code
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: üì¶ Install paramiko and scp
        run: |
          pip install paramiko scp

      - name: üöÄ Run deployment script
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          python <<EOF
          import paramiko
          import os

          host = os.getenv("SERVER_IP")
          user = os.getenv("SERVER_USER")
          password = os.getenv("SERVER_PASSWORD")

          ssh = paramiko.SSHClient()
          ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
          ssh.connect(hostname=host, username=user, password=password)

          stdin, stdout, stderr = ssh.exec_command("""
            cd /root/promo_discount &&
            
            # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã __pycache__ –∏ –¥—Ä—É–≥–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–¥ pull
            find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
            find . -type f -name "*.pyc" -delete 2>/dev/null || true
            find . -type f -name "*.pyo" -delete 2>/dev/null || true
            
            # –£–¥–∞–ª—è–µ–º __pycache__ –∏–∑ –∏–Ω–¥–µ–∫—Å–∞ git (–µ—Å–ª–∏ –æ–Ω–∏ —Ç–∞–º –µ—Å—Ç—å)
            git rm -r --cached --ignore-unmatch modules/__pycache__ 2>/dev/null || true
            git rm -r --cached --ignore-unmatch __pycache__ 2>/dev/null || true
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏ –¥–µ–ª–∞–µ–º pull
            git stash 2>/dev/null || true
            git pull origin main || {
              echo "–û—à–∏–±–∫–∞ –ø—Ä–∏ pull. –ü—ã—Ç–∞–µ–º—Å—è —Å–±—Ä–æ—Å–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
              git reset --hard origin/main
            }
            
            # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
            source venv/bin/activate &&
            
            # –û–±–Ω–æ–≤–ª—è–µ–º pip
            pip install --upgrade pip &&
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            if [ -f requirements.txt ]; then
              pip install -r requirements.txt --no-cache-dir
            fi &&
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
            systemctl daemon-reload &&
            systemctl restart promo_sales || echo "‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å promo_sales –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω"
          """)

          print(stdout.read().decode())
          print(stderr.read().decode())
          EOF
